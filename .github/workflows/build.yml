name: Build PKGBUILD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Update system and install dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm base-devel rust cargo git \
          cairo \
          pango \
          gdk-pixbuf2 \
          gtk3 \
          gtk4 \
          pkg-config \
          glib2 \
          libpulse \
          libxcb \
          xcb-util \
          wayland \
          meson \
          ninja \
          gobject-introspection \
          vala
    
    - name: Create build user
      run: |
        useradd -m builder
        echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
        chown -R builder:builder .
    
    - name: Install gtk4-layer-shell from AUR
      run: |
        cd /tmp
        su - builder -c "cd /tmp && git clone https://aur.archlinux.org/gtk4-layer-shell.git"
        chown -R builder:builder /tmp/gtk4-layer-shell
        cd gtk4-layer-shell
        su - builder -c "cd /tmp/gtk4-layer-shell && makepkg -si --noconfirm"
    
    - name: Build package from build/PKGBUILD
      run: |
        cd build
        su - builder -c "cd $(pwd) && makepkg -sf --noconfirm"
    
    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: hybar-package
        path: 'build/*.pkg.tar.zst'
        retention-days: 30
